<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¤‘êµ­ì–´ í•™ìŠµ ì•±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chinese-font {
            font-family: serif, "SimSun", "Microsoft YaHei", "PingFang SC", "Hiragino Sans GB", sans-serif;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gradient-to-br from-red-50 to-yellow-50 p-4">
        <div class="max-w-2xl mx-auto">
            <!-- í—¤ë” -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-red-600 mb-2 chinese-font">ä¸­æ–‡å­¦ä¹ </h1>
                <p class="text-lg text-gray-600">ì¤‘êµ­ì–´ ë°œìŒ í•™ìŠµ ì•±</p>
            </div>

            <!-- ë¬¸ì œ ìœ í˜• ì„ íƒ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <button id="btn-pinyin" class="py-3 px-4 rounded-lg font-semibold transition-all bg-red-500 text-white shadow-lg">
                    í•œì–´ë³‘ìŒ ë°œìŒ
                </button>
                <button id="btn-greeting" class="py-3 px-4 rounded-lg font-semibold transition-all bg-white text-red-500 border-2 border-red-500 hover:bg-red-50">
                    ì¸ì‚¬ë§ ë²ˆì—­
                </button>
                <button id="btn-character" class="py-3 px-4 rounded-lg font-semibold transition-all bg-white text-red-500 border-2 border-red-500 hover:bg-red-50">
                    í•œì ë°œìŒ
                </button>
            </div>

            <!-- í•™ìŠµ ëª¨ë“œ ì„ íƒ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <button id="btn-all" class="py-2 px-4 rounded-lg font-semibold transition-all bg-blue-500 text-white shadow-lg">
                    ì „ì²´ í•™ìŠµ (<span id="count-all">0</span>ë¬¸ì œ)
                </button>
                <button id="btn-known" class="py-2 px-4 rounded-lg font-semibold transition-all bg-white text-green-500 border-2 border-green-500 hover:bg-green-50">
                    ì•„ëŠ” ë¬¸ì œ (<span id="count-known">0</span>ë¬¸ì œ)
                </button>
                <button id="btn-unknown" class="py-2 px-4 rounded-lg font-semibold transition-all bg-white text-orange-500 border-2 border-orange-500 hover:bg-orange-50">
                    ëª¨ë¥´ëŠ” ë¬¸ì œ (<span id="count-unknown">0</span>ë¬¸ì œ)
                </button>
            </div>

            <!-- í€´ì¦ˆ ì¹´ë“œ -->
            <div class="bg-white rounded-xl shadow-xl p-8 mb-6">
                <div class="text-center mb-8">
                    <div class="text-sm text-gray-500 mb-2" id="progress">
                        ë¼ìš´ë“œ 1 - ë¬¸ì œ 1 / 1
                    </div>
                    
                    <!-- ë¬¸ì œ ë‚´ìš© -->
                    <div id="question-content">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>

                    <!-- ì •ë‹µ ë°œìŒ ë“£ê¸° ë²„íŠ¼ -->
                    <button id="btn-audio" class="inline-flex items-center gap-2 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors mb-4 text-lg font-semibold">
                        ğŸ”Š ì „ë¬¸ê°€ ì¤‘êµ­ì–´ ë°œìŒ ë“£ê¸°
                    </button>

                    <!-- í•œì–´ë³‘ìŒ ë³´ê¸° ë²„íŠ¼ -->
                    <div id="pinyin-toggle" class="mb-4" style="display: none;">
                        <button id="btn-show-pinyin" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg transition-colors mr-2 text-white bg-blue-500 hover:bg-blue-600">
                            ğŸ‘ í•œì–´ë³‘ìŒ ë³´ê¸°
                        </button>
                        <div id="pinyin-display" class="mt-2 text-2xl text-purple-600 font-bold" style="display: none;"></div>
                    </div>
                </div>

                <!-- ë²„íŠ¼ë“¤ -->
                <div class="flex gap-4 justify-center">
                    <!-- ì•Œì•„ìš”/ëª°ë¼ìš” ë²„íŠ¼ -->
                    <div class="flex gap-2 mb-4">
                        <button id="btn-known-answer" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                            âœ“ ì•Œì•„ìš”
                        </button>
                        <button id="btn-unknown-answer" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-orange-600 transition-colors">
                            âœ— ëª°ë¼ìš”
                        </button>
                    </div>
                </div>

                <div class="flex gap-4 justify-center">
                    <button id="btn-next" class="bg-blue-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                        ë‹¤ìŒ ë¬¸ì œ
                    </button>
                    
                    <button id="btn-reset" class="inline-flex items-center gap-2 bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                        ğŸ”„ ì²˜ìŒë¶€í„°
                    </button>
                </div>
            </div>

            <!-- ì‚¬ìš©ë²• ì•ˆë‚´ -->
            <div class="bg-white rounded-lg p-6 shadow-md">
                <h3 class="text-lg font-semibold mb-3 text-red-600">ì‚¬ìš©ë²• ë° ìŒì„± ê¸°ëŠ¥</h3>
                <div class="text-sm text-gray-600 space-y-2">
                    <p><strong>í•™ìŠµ ë°©ì‹:</strong></p>
                    <ul class="ml-4 space-y-1">
                        <li>â€¢ ëª¨ë“  ë¬¸ì œê°€ í•œ ë²ˆì”© ë‚˜ì˜¬ ë•Œê¹Œì§€ ëœë¤ ìˆœì„œë¡œ ì¶œì œ</li>
                        <li>â€¢ í•œ ë¼ìš´ë“œ ì™„ë£Œ í›„ ë‹¤ì‹œ ì…”í”Œë˜ì–´ ìƒˆë¡œìš´ ëœë¤ ìˆœì„œë¡œ ë°˜ë³µ</li>
                        <li>â€¢ ê°™ì€ ë¼ìš´ë“œ ë‚´ì—ì„œëŠ” ì¤‘ë³µ ë¬¸ì œ ì—†ìŒ</li>
                    </ul>
                    <p><strong>í•™ìŠµ ëª¨ë“œ:</strong></p>
                    <ul class="ml-4 space-y-1">
                        <li>â€¢ <strong>ì „ì²´ í•™ìŠµ:</strong> ëª¨ë“  ë¬¸ì œë¥¼ í•™ìŠµí•©ë‹ˆë‹¤</li>
                        <li>â€¢ <strong>ì•„ëŠ” ë¬¸ì œ:</strong> "ì•Œì•„ìš”"ë¡œ í‘œì‹œí•œ ë¬¸ì œë§Œ í•™ìŠµí•©ë‹ˆë‹¤</li>
                        <li>â€¢ <strong>ëª¨ë¥´ëŠ” ë¬¸ì œ:</strong> "ëª°ë¼ìš”"ë¡œ í‘œì‹œí•œ ë¬¸ì œë§Œ í•™ìŠµí•©ë‹ˆë‹¤</li>
                    </ul>
                    <p><strong>ì•Œì•„ìš”/ëª°ë¼ìš” ë²„íŠ¼:</strong> ê° ë¬¸ì œì— ëŒ€í•œ ì´í•´ë„ë¥¼ í‘œì‹œí•˜ê³  ìë™ìœ¼ë¡œ ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.</p>
                    <p><strong>í•œì–´ë³‘ìŒ ë°œìŒ:</strong> ì£¼ì–´ì§„ í•œì–´ë³‘ìŒ(ì„±ì¡° í¬í•¨)ì„ ë³´ê³  í•´ë‹¹í•˜ëŠ” ì¤‘êµ­ì–´ ë°œìŒì„ ë“¤ì–´ë³´ì„¸ìš”.</p>
                    <p><strong>ì„±ì¡° í•™ìŠµ:</strong> ì¤‘êµ­ì–´ì˜ 4ê°€ì§€ ì„±ì¡°(1ì„±:Ë‰, 2ì„±:ËŠ, 3ì„±:Ë‡, 4ì„±:Ë‹)ê°€ í‘œì‹œë˜ì–´ ì •í™•í•œ ë°œìŒ í•™ìŠµì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                    <p><strong>ì¸ì‚¬ë§ ë²ˆì—­:</strong> í•œêµ­ì–´ ì¸ì‚¬ë§ì— í•´ë‹¹í•˜ëŠ” ì¤‘êµ­ì–´ ë°œìŒì„ ë“¤ì–´ë³´ì„¸ìš”.</p>
                    <p><strong>í•œì ë°œìŒ:</strong> í•œìë¥¼ ë³´ê³  ì¤‘êµ­ì–´ì‹ ë°œìŒ(í•œì–´ë³‘ìŒ)ì„ ë§ì¶°ë³´ì„¸ìš”. ì˜ˆ: å¥½ â†’ hao</p>
                    <p><strong>ìŒì„± ê¸°ëŠ¥:</strong> ë¸Œë¼ìš°ì € ë‚´ì¥ ìŒì„± í•©ì„± ì—”ì§„(Web Speech API)ì„ ì‚¬ìš©í•˜ì—¬ ì¤‘êµ­ì–´ ë°œìŒì„ ì¬ìƒí•©ë‹ˆë‹¤.</p>
                    <p><strong>í•œì–´ë³‘ìŒ ë³´ê¸°:</strong> ì¸ì‚¬ë§ ëª¨ë“œì™€ í•œì ëª¨ë“œì—ì„œ íŒíŠ¸ë¡œ í•œì–´ë³‘ìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <p class="text-xs text-gray-500 mt-2">
                        â€» ìŒì„± í’ˆì§ˆì€ ì‚¬ìš©í•˜ëŠ” ë¸Œë¼ìš°ì €ì™€ ìš´ì˜ì²´ì œì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Chrome, Edge ë“±ì—ì„œ ë” ìì—°ìŠ¤ëŸ¬ìš´ ì¤‘êµ­ì–´ ë°œìŒì„ ì œê³µí•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì•± ìƒíƒœ
        let currentMode = 'pinyin';
        let studyMode = 'all';
        let currentQuestion = 0;
        let showPinyin = false;
        let knownQuestions = new Set();
        let unknownQuestions = new Set();
        let shuffledQuestions = [];
        let completedQuestions = new Set();
        let roundCount = 1;

        // ë¬¸ì œ ë°ì´í„°
        const pinyinQuestions = [
            { pinyin: 'fÄ“i jÄ«', chinese: 'é£æœº', korean: 'ë¹„í–‰ê¸°', audio: 'fei-ji' },
            { pinyin: 'gÅng yuÃ¡n', chinese: 'å…¬å›­', korean: 'ê³µì›', audio: 'gong-yuan' },
            { pinyin: 'gÅng zhÇ”', chinese: 'å…¬ä¸»', korean: 'ê³µì£¼', audio: 'gong-zhu' },
            { pinyin: 'shÄ“ng rÃ¬', chinese: 'ç”Ÿæ—¥', korean: 'ìƒì¼', audio: 'sheng-ri' },
            { pinyin: 'gÄ“ ge', chinese: 'å“¥å“¥', korean: 'í˜•/ì˜¤ë¹ ', audio: 'ge-ge' },
            { pinyin: 'xiÃ³ng mÄo', chinese: 'ç†ŠçŒ«', korean: 'íŒë‹¤', audio: 'xiong-mao' },
            { pinyin: 'qÃ­ pÃ¡o', chinese: 'æ——è¢', korean: 'ì¹˜íŒŒì˜¤', audio: 'qi-pao' },
            { pinyin: 'nÃ¡n nÇš', chinese: 'ç”·å¥³', korean: 'ë‚¨ë…€', audio: 'nan-nu' },
            { pinyin: 'xuÃ© xiÃ o', chinese: 'å­¦æ ¡', korean: 'í•™êµ', audio: 'xue-xiao' },
            { pinyin: 'yÃ© ye', chinese: 'çˆ·çˆ·', korean: 'í• ì•„ë²„ì§€', audio: 'ye-ye' },
            { pinyin: 'lÇo shÄ«', chinese: 'è€å¸ˆ', korean: 'ì„ ìƒë‹˜', audio: 'lao-shi' },
            { pinyin: 'mÄ›i guÃ³', chinese: 'ç¾å›½', korean: 'ë¯¸êµ­', audio: 'mei-guo' },
            { pinyin: 'shuÇ guÇ’', chinese: 'æ°´æœ', korean: 'ê³¼ì¼', audio: 'shui-guo' },
            { pinyin: 'nÇ” lÃ¬', chinese: 'åŠªåŠ›', korean: 'ë…¸ë ¥í•˜ë‹¤', audio: 'nu-li' },
            { pinyin: 'jiÄ› jie', chinese: 'å§å§', korean: 'ëˆ„ë‚˜/ì–¸ë‹ˆ', audio: 'jie-jie' },
            { pinyin: 'chÃ ng gÄ“', chinese: 'å”±æ­Œ', korean: 'ë…¸ë˜í•˜ë‹¤', audio: 'chang-ge' },
            { pinyin: 'tÃ i yÃ¡ng', chinese: 'å¤ªé˜³', korean: 'íƒœì–‘', audio: 'tai-yang' },
            { pinyin: 'fÃ¹ mÇ”', chinese: 'çˆ¶æ¯', korean: 'ë¶€ëª¨', audio: 'fu-mu' },
            { pinyin: 'diÃ n huÃ ', chinese: 'ç”µè¯', korean: 'ì „í™”', audio: 'dian-hua' },
            { pinyin: 'mÃ¨i mei', chinese: 'å¦¹å¦¹', korean: 'ì—¬ë™ìƒ', audio: 'mei-mei' },
            { pinyin: 'hÄ“i bÇn', chinese: 'é»‘æ¿', korean: 'ì¹ íŒ', audio: 'hei-ban' },
            { pinyin: 'diÃ n nÇo', chinese: 'ç”µè„‘', korean: 'ì»´í“¨í„°', audio: 'dian-nao' },
            { pinyin: 'zhuÅ zi', chinese: 'æ¡Œå­', korean: 'ì±…ìƒ', audio: 'zhuo-zi' },
            { pinyin: 'bÄo', chinese: 'åŒ…', korean: 'ê°€ë°©', audio: 'bao' },
            { pinyin: 'yÇ zi', chinese: 'æ¤…å­', korean: 'ì˜ì', audio: 'yi-zi' },
            { pinyin: 'niÃº nÇi', chinese: 'ç‰›å¥¶', korean: 'ìš°ìœ ', audio: 'niu-nai' },
            { pinyin: 'yÄ«', chinese: 'ä¸€', korean: '1', audio: 'yi' },
            { pinyin: 'Ã¨r', chinese: 'äºŒ', korean: '2', audio: 'er' },
            { pinyin: 'sÄn', chinese: 'ä¸‰', korean: '3', audio: 'san' },
            { pinyin: 'sÃ¬', chinese: 'å››', korean: '4', audio: 'si' },
            { pinyin: 'wÇ”', chinese: 'äº”', korean: '5', audio: 'wu' },
            { pinyin: 'liÃ¹', chinese: 'å…­', korean: '6', audio: 'liu' },
            { pinyin: 'qÄ«', chinese: 'ä¸ƒ', korean: '7', audio: 'qi' },
            { pinyin: 'bÄ', chinese: 'å…«', korean: '8', audio: 'ba' },
            { pinyin: 'jiÇ”', chinese: 'ä¹', korean: '9', audio: 'jiu' },
            { pinyin: 'shÃ­', chinese: 'å', korean: '10', audio: 'shi' },
            { pinyin: 'dÅng xÄ« nÃ¡n bÄ›i', chinese: 'ä¸œè¥¿å—åŒ—', korean: 'ë™ì„œë‚¨ë¶', audio: 'dong-xi-nan-bei' },
            { pinyin: 'wÇ” xÄ«ng hÃ³ng qÃ­', chinese: 'äº”æ˜Ÿçº¢æ——', korean: 'ì˜¤ì„±í™ê¸°', audio: 'wu-xing-hong-qi' },
            { pinyin: 'nÇ', chinese: 'ä½ ', korean: 'ë„ˆ/ë‹¹ì‹ ', audio: 'ni' },
            { pinyin: 'hÇo', chinese: 'å¥½', korean: 'ì¢‹ë‹¤/ì•ˆë…•í•˜ë‹¤', audio: 'hao' },
            { pinyin: 'nÇ men', chinese: 'ä½ ä»¬', korean: 'ë„ˆí¬(ë“¤)', audio: 'ni-men' },
            { pinyin: 'jiÃ n miÃ n', chinese: 'è§é¢', korean: 'ë§Œë‚˜ë‹¤/ë³´ë‹¤', audio: 'jian-mian' },
            { pinyin: 'nÃ­n', chinese: 'æ‚¨', korean: 'ë‹¹ì‹ ì˜ ì¡´ì¹­', audio: 'nin' },
            { pinyin: 'dÃ  jiÄ', chinese: 'å¤§å®¶', korean: 'ì—¬ëŸ¬ë¶„/ëª¨ë‘ë“¤', audio: 'da-jia' },
            { pinyin: 'wÇ’', chinese: 'æˆ‘', korean: 'ë‚˜', audio: 'wo' },
            { pinyin: 'wÇ’ men', chinese: 'æˆ‘ä»¬', korean: 'ìš°ë¦¬ë“¤', audio: 'wo-men' },
            { pinyin: 'tÄ', chinese: 'ä»–', korean: 'ê·¸', audio: 'ta' },
            { pinyin: 'tÄ men', chinese: 'ä»–ä»¬', korean: 'ê·¸ë“¤', audio: 'ta-men' },
            { pinyin: 'tÄ', chinese: 'å¥¹', korean: 'ê·¸ë…€', audio: 'ta2' },
            { pinyin: 'tÄ men', chinese: 'å¥¹ä»¬', korean: 'ê·¸ë…€ë“¤', audio: 'ta-men2' }
        ];

        const characterQuestions = [
            { chinese: 'å¥½', pinyin: 'hÇo', korean: 'ì¢‹ë‹¤', audio: 'hao' },
            { chinese: 'ä¸', pinyin: 'bÃ¹', korean: '~ì´ ì•„ë‹ˆë‹¤', audio: 'bu' }
        ];

        const greetingQuestions = [
            { korean: 'ì•ˆë…•!', chinese: 'ä½ å¥½!', pinyin: 'nÇ hÇo!', audio: 'ni-hao' },
            { korean: 'ì–˜ë“¤ì•„ ì•ˆë…•!', chinese: 'ä½ ä»¬å¥½!', pinyin: 'nÇ men hÇo!', audio: 'ni-men-hao' },
            { korean: 'ì˜ê°€!', chinese: 'å†è§!', pinyin: 'zÃ i jiÃ n!', audio: 'zai-jian' },
            { korean: 'ë‚´ì¼ ë³´ì!', chinese: 'æ˜å¤©è§!', pinyin: 'mÃ­ng tiÄn jiÃ n!', audio: 'ming-tian-jian' },
            { korean: 'ì¢‹ì€ ì•„ì¹¨!', chinese: 'æ—©ä¸Šå¥½!', pinyin: 'zÇo shÃ ng hÇo!', audio: 'zao-shang-hao' },
            { korean: 'ì¢‹ì€ ì €ë…!', chinese: 'æ™šä¸Šå¥½!', pinyin: 'wÇn shÃ ng hÇo!', audio: 'wan-shang-hao' },
            { korean: 'ì˜ì!', chinese: 'æ™šå®‰!', pinyin: 'wÇn Än!', audio: 'wan-an' },
            { korean: 'ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤!', chinese: 'å¾ˆé«˜å…´è®¤è¯†ä½ !', pinyin: 'hÄ›n gÄo xÃ¬ng rÃ¨n shi nÇ!', audio: 'hen-gao-xing-ren-shi-ni' },
            { korean: 'ì˜¤ëœë§Œì´ì•¼!', chinese: 'è®¤è¯†ä½ å¾ˆé«˜å…´!', pinyin: 'rÃ¨n shi nÇ hÄ›n gÄo xÃ¬ng!', audio: 'ren-shi-ni-hen-gao-xing' },
            { korean: 'ì–´ì„œì˜¤ì„¸ìš”/ì˜¤ì‹ ê±¸ í™˜ì˜í•©ë‹ˆë‹¤.', chinese: 'æ¬¢è¿å…‰ä¸´!', pinyin: 'huÄn yÃ­ng guÄng lÃ­n!', audio: 'huan-ying-guang-lin' },
            { korean: 'ì‚´í´ê°€ì„¸ìš”!', chinese: 'æ…¢èµ°!', pinyin: 'mÃ n zÇ’u!', audio: 'man-zou' },
            { korean: 'ë‹¤ìŒì— ë³´ì!', chinese: 'ä¸‹æ¬¡è§!', pinyin: 'xiÃ  cÃ¬ jiÃ n!', audio: 'xia-ci-jian' },
            { korean: 'ì ì‹œí›„ì— ë³´ì!', chinese: 'ä¸€ä¼šå„¿è§!', pinyin: 'yÄ« huÃ¬ Ã©r jiÃ n!', audio: 'yi-hui-er-jian' }
        ];

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function getCurrentData() {
            if (currentMode === 'pinyin') return pinyinQuestions;
            if (currentMode === 'greeting') return greetingQuestions;
            return characterQuestions;
        }

        function getFilteredQuestions() {
            const currentData = getCurrentData();
            const dataKey = currentMode;
            
            if (studyMode === 'known') {
                return currentData.filter((_, index) => knownQuestions.has(dataKey + '-' + index));
            } else if (studyMode === 'unknown') {
                return currentData.filter((_, index) => unknownQuestions.has(dataKey + '-' + index));
            }
            return currentData;
        }

        // ëª¨ë°”ì¼ ìŒì„± ìƒíƒœ ê´€ë¦¬
        let isMobileAudioInitialized = false;
        let isPlayingAudio = false;

        function playAudio(text) {
            // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ê°ì§€
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);

            if (!('speechSynthesis' in window)) {
                alert('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì¶”ì²œ ë¸Œë¼ìš°ì €:\nâ€¢ Android: Chrome\nâ€¢ iPhone: Safari');
                return;
            }

            // ì´ë¯¸ ì¬ìƒ ì¤‘ì´ë©´ ì¤‘ë‹¨
            if (isPlayingAudio) {
                speechSynthesis.cancel();
                isPlayingAudio = false;
                return;
            }

            // ëª¨ë°”ì¼ì—ì„œ ì²« ë²ˆì§¸ ì‚¬ìš© ì‹œ ì´ˆê¸°í™”
            if (isMobile && !isMobileAudioInitialized) {
                initializeMobileAudio();
                isMobileAudioInitialized = true;
                
                // ì´ˆê¸°í™” í›„ ì ì‹œ ëŒ€ê¸°
                setTimeout(() => playAudioInternal(text, isMobile, isIOS, isAndroid), 300);
                return;
            }

            playAudioInternal(text, isMobile, isIOS, isAndroid);
        }

        function playAudioInternal(text, isMobile, isIOS, isAndroid) {
            try {
                // ì´ì „ ìŒì„± ì¬ìƒ ì™„ì „íˆ ì¤‘ë‹¨
                speechSynthesis.cancel();
                
                // ì ì‹œ ëŒ€ê¸° í›„ ì¬ìƒ (ëª¨ë°”ì¼ì—ì„œ ì¤‘ìš”)
                setTimeout(() => {
                    const voices = speechSynthesis.getVoices();
                    console.log(`ğŸµ ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„± ê°œìˆ˜: ${voices.length}`);
                    
                    // ì¤‘êµ­ì–´ ìŒì„± ì°¾ê¸°
                    let chineseVoices = voices.filter(voice => 
                        voice.lang && (
                            voice.lang.toLowerCase().includes('zh') || 
                            voice.lang.toLowerCase().includes('chinese') ||
                            voice.name.toLowerCase().includes('chinese') ||
                            voice.name.toLowerCase().includes('mandarin')
                        )
                    );

                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // ëª¨ë°”ì¼ë³„ ìµœì  ì„¤ì •
                    if (isIOS) {
                        // iOS Safari ìµœì í™”
                        utterance.lang = 'zh-CN';
                        utterance.rate = 0.8;
                        utterance.pitch = 1.0;
                        utterance.volume = 1.0;
                        
                        // iOSì—ì„œ ê°€ëŠ¥í•œ ì¤‘êµ­ì–´ ìŒì„± ì„ íƒ
                        if (chineseVoices.length > 0) {
                            utterance.voice = chineseVoices[0];
                        }
                    } else if (isAndroid) {
                        // Android Chrome ìµœì í™”
                        utterance.lang = 'zh-CN';
                        utterance.rate = 0.7;
                        utterance.pitch = 1.0;
                        utterance.volume = 1.0;
                        
                        if (chineseVoices.length > 0) {
                            const preferredVoice = chineseVoices.find(voice => 
                                voice.name.toLowerCase().includes('female')
                            ) || chineseVoices[0];
                            utterance.voice = preferredVoice;
                        }
                    } else {
                        // ë°ìŠ¤í¬í†± ì„¤ì •
                        utterance.lang = 'zh-CN';
                        utterance.rate = 0.7;
                        utterance.pitch = 1.0;
                        utterance.volume = 0.9;
                        
                        if (chineseVoices.length > 0) {
                            const preferredVoice = chineseVoices.find(voice => 
                                voice.lang === 'zh-CN' && voice.name.includes('Female')
                            ) || chineseVoices.find(voice => 
                                voice.lang === 'zh-CN'
                            ) || chineseVoices[0];
                            utterance.voice = preferredVoice;
                        }
                    }

                    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                    utterance.onstart = function() {
                        isPlayingAudio = true;
                        console.log('ğŸ”Š ìŒì„± ì¬ìƒ ì‹œì‘:', text);
                        
                        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                        const audioBtn = document.getElementById('btn-audio');
                        if (audioBtn) {
                            audioBtn.textContent = 'â¹ï¸ ì •ì§€';
                            audioBtn.style.backgroundColor = '#ef4444';
                        }
                    };
                    
                    utterance.onend = function() {
                        isPlayingAudio = false;
                        console.log('âœ… ìŒì„± ì¬ìƒ ì™„ë£Œ');
                        
                        // ë²„íŠ¼ ìƒíƒœ ë³µì›
                        const audioBtn = document.getElementById('btn-audio');
                        if (audioBtn) {
                            audioBtn.textContent = 'ğŸ”Š ì „ë¬¸ê°€ ì¤‘êµ­ì–´ ë°œìŒ ë“£ê¸°';
                            audioBtn.style.backgroundColor = '#22c55e';
                        }
                    };
                    
                    utterance.onerror = function(event) {
                        isPlayingAudio = false;
                        console.error('âŒ ìŒì„± ì¬ìƒ ì˜¤ë¥˜:', event.error);
                        
                        // ë²„íŠ¼ ìƒíƒœ ë³µì›
                        const audioBtn = document.getElementById('btn-audio');
                        if (audioBtn) {
                            audioBtn.textContent = 'ğŸ”Š ì „ë¬¸ê°€ ì¤‘êµ­ì–´ ë°œìŒ ë“£ê¸°';
                            audioBtn.style.backgroundColor = '#22c55e';
                        }
                        
                        // ëª¨ë°”ì¼ì—ì„œ ì¬ì‹œë„
                        if (isMobile && event.error !== 'canceled') {
                            setTimeout(() => {
                                console.log('ğŸ”„ ëª¨ë°”ì¼ ìŒì„± ì¬ì‹œë„...');
                                const retryUtterance = new SpeechSynthesisUtterance(text);
                                retryUtterance.lang = 'zh-CN';
                                retryUtterance.rate = 1.0;
                                retryUtterance.volume = 1.0;
                                speechSynthesis.speak(retryUtterance);
                            }, 500);
                        }
                    };

                    // ìŒì„± ì¬ìƒ
                    speechSynthesis.speak(utterance);
                    
                    // iOSì—ì„œ ê¸´ í…ìŠ¤íŠ¸ ì²˜ë¦¬
                    if (isIOS) {
                        const keepAlive = setInterval(() => {
                            if (!speechSynthesis.speaking) {
                                clearInterval(keepAlive);
                            } else {
                                speechSynthesis.pause();
                                speechSynthesis.resume();
                            }
                        }, 10000);
                        
                        utterance.onend = function() {
                            clearInterval(keepAlive);
                            isPlayingAudio = false;
                            
                            const audioBtn = document.getElementById('btn-audio');
                            if (audioBtn) {
                                audioBtn.textContent = 'ğŸ”Š ì „ë¬¸ê°€ ì¤‘êµ­ì–´ ë°œìŒ ë“£ê¸°';
                                audioBtn.style.backgroundColor = '#22c55e';
                            }
                        };
                    }
                    
                }, isMobile ? 100 : 50);
                
            } catch (error) {
                console.error('ìŒì„± ì¬ìƒ ì¤‘ ì˜¤ë¥˜:', error);
                isPlayingAudio = false;
                
                if (isMobile) {
                    alert('âŒ ìŒì„± ì¬ìƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨\n2. ë‹¤ë¥¸ ë¸Œë¼ìš°ì € ì‚¬ìš©\n3. íœ´ëŒ€í° ë³¼ë¥¨ í™•ì¸');
                }
            }
        }

        function initializeMobileAudio() {
            console.log('ğŸ“± ëª¨ë°”ì¼ ìŒì„± ì—”ì§„ ì´ˆê¸°í™” ì¤‘...');
            
            // ë”ë¯¸ ìŒì„±ìœ¼ë¡œ ì´ˆê¸°í™”
            try {
                const initUtterance = new SpeechSynthesisUtterance(' ');
                initUtterance.volume = 0.01;
                initUtterance.rate = 10;
                speechSynthesis.speak(initUtterance);
                
                setTimeout(() => {
                    speechSynthesis.cancel();
                    console.log('âœ… ëª¨ë°”ì¼ ìŒì„± ì—”ì§„ ì´ˆê¸°í™” ì™„ë£Œ');
                }, 100);
            } catch (error) {
                console.error('ëª¨ë°”ì¼ ìŒì„± ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        // ìŒì„± ëª©ë¡ì´ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” í•¨ìˆ˜
        function loadVoices() {
            return new Promise((resolve) => {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    resolve(voices);
                } else {
                    speechSynthesis.onvoiceschanged = () => {
                        resolve(speechSynthesis.getVoices());
                    };
                }
            });
        }

        function updateQuestionCounts() {
            const currentData = getCurrentData();
            const dataKey = currentMode;
            
            const knownCount = currentData.filter((_, index) => knownQuestions.has(dataKey + '-' + index)).length;
            const unknownCount = currentData.filter((_, index) => unknownQuestions.has(dataKey + '-' + index)).length;
            
            document.getElementById('count-all').textContent = currentData.length;
            document.getElementById('count-known').textContent = knownCount;
            document.getElementById('count-unknown').textContent = unknownCount;
        }

        function initializeShuffledQuestions() {
            const filteredQuestions = getFilteredQuestions();
            if (filteredQuestions.length > 0) {
                shuffledQuestions = shuffleArray(filteredQuestions.map((item, index) => ({ item, originalIndex: index })));
                currentQuestion = 0;
                completedQuestions = new Set();
                roundCount = 1;
            } else {
                shuffledQuestions = [];
            }
        }

        function renderQuestion() {
            const questionContent = document.getElementById('question-content');
            const pinyinToggle = document.getElementById('pinyin-toggle');
            const progress = document.getElementById('progress');
            
            if (shuffledQuestions.length === 0) {
                questionContent.innerHTML = '<div class="text-lg text-gray-600">í•´ë‹¹ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                progress.textContent = 'ë¬¸ì œ ì—†ìŒ';
                pinyinToggle.style.display = 'none';
                return;
            }

            const currentItem = shuffledQuestions[currentQuestion].item;
            progress.textContent = 'ë¼ìš´ë“œ ' + roundCount + ' - ë¬¸ì œ ' + (completedQuestions.size + 1) + ' / ' + shuffledQuestions.length;

            if (currentMode === 'pinyin') {
                questionContent.innerHTML = 
                    '<div class="text-4xl font-bold text-gray-800 mb-4">' + currentItem.pinyin + '</div>' +
                    '<p class="text-lg text-gray-600 mb-6">ìœ„ í•œì–´ë³‘ìŒì˜ ë°œìŒì„ ë“¤ì–´ë³´ì„¸ìš”</p>' +
                    '<div class="bg-gray-50 p-4 rounded-lg mb-4">' +
                        '<div class="text-2xl font-bold text-red-600 mb-2 chinese-font">' + currentItem.chinese + '</div>' +
                        '<div class="text-lg text-gray-600">' + currentItem.korean + '</div>' +
                    '</div>';
                pinyinToggle.style.display = 'none';
            } else if (currentMode === 'greeting') {
                questionContent.innerHTML = 
                    '<div class="text-3xl font-bold text-blue-600 mb-4">"' + currentItem.korean + '"</div>' +
                    '<p class="text-lg text-gray-600 mb-6">ìœ„ í•œêµ­ì–´ì˜ ì¤‘êµ­ì–´ ë°œìŒì„ ë“¤ì–´ë³´ì„¸ìš”</p>' +
                    '<div class="bg-gray-50 p-4 rounded-lg mb-4">' +
                        '<div class="text-2xl font-bold text-red-600 chinese-font">' + currentItem.chinese + '</div>' +
                    '</div>';
                pinyinToggle.style.display = 'block';
                document.getElementById('btn-show-pinyin').textContent = 'ğŸ‘ í•œì–´ë³‘ìŒ ' + (showPinyin ? 'ìˆ¨ê¸°ê¸°' : 'ë³´ê¸°');
                document.getElementById('pinyin-display').textContent = currentItem.pinyin;
                document.getElementById('pinyin-display').style.display = showPinyin ? 'block' : 'none';
            } else { // character
                questionContent.innerHTML = 
                    '<div class="text-6xl font-bold text-gray-800 mb-4 chinese-font">' + currentItem.chinese + '</div>' +
                    '<p class="text-lg text-gray-600 mb-6">ìœ„ í•œìì˜ ì¤‘êµ­ì–´ ë°œìŒì„ ë“¤ì–´ë³´ì„¸ìš”</p>' +
                    '<div class="bg-gray-50 p-4 rounded-lg mb-4">' +
                        '<div class="text-lg text-gray-600">ëœ»: ' + currentItem.korean + '</div>' +
                    '</div>';
                pinyinToggle.style.display = 'block';
                document.getElementById('btn-show-pinyin').textContent = 'ğŸ‘ ë°œìŒ ' + (showPinyin ? 'ìˆ¨ê¸°ê¸°' : 'ë³´ê¸°');
                document.getElementById('pinyin-display').textContent = currentItem.pinyin;
                document.getElementById('pinyin-display').style.display = showPinyin ? 'block' : 'none';
            }
        }

        function nextQuestion() {
            if (shuffledQuestions.length <= 1) return;
            
            const currentQuestionIndex = currentQuestion;
            completedQuestions.add(currentQuestionIndex);
            
            if (completedQuestions.size >= shuffledQuestions.length) {
                const newShuffled = shuffleArray([...shuffledQuestions]);
                shuffledQuestions = newShuffled;
                currentQuestion = 0;
                completedQuestions = new Set();
                roundCount++;
            } else {
                let nextIndex = (currentQuestion + 1) % shuffledQuestions.length;
                while (completedQuestions.has(nextIndex) && completedQuestions.size < shuffledQuestions.length - 1) {
                    nextIndex = (nextIndex + 1) % shuffledQuestions.length;
                }
                currentQuestion = nextIndex;
            }
            
            showPinyin = false;
            renderQuestion();
        }

        function markAsKnown() {
            if (shuffledQuestions.length === 0) return;
            const originalIndex = shuffledQuestions[currentQuestion].originalIndex;
            const questionKey = currentMode + '-' + originalIndex;
            knownQuestions.add(questionKey);
            unknownQuestions.delete(questionKey);
            updateQuestionCounts();
            nextQuestion();
        }

        function markAsUnknown() {
            if (shuffledQuestions.length === 0) return;
            const originalIndex = shuffledQuestions[currentQuestion].originalIndex;
            const questionKey = currentMode + '-' + originalIndex;
            unknownQuestions.add(questionKey);
            knownQuestions.delete(questionKey);
            updateQuestionCounts();
            nextQuestion();
        }

        function resetQuiz() {
            initializeShuffledQuestions();
            showPinyin = false;
            renderQuestion();
        }

        function switchMode(mode) {
            currentMode = mode;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('[id^="btn-"]:not([id^="btn-all"]):not([id^="btn-known"]):not([id^="btn-unknown"])').forEach(btn => {
                btn.className = btn.className.replace(/bg-red-500 text-white shadow-lg/, 'bg-white text-red-500 border-2 border-red-500 hover:bg-red-50');
            });
            document.getElementById('btn-' + mode).className = document.getElementById('btn-' + mode).className.replace(/bg-white text-red-500 border-2 border-red-500 hover:bg-red-50/, 'bg-red-500 text-white shadow-lg');
            
            updateQuestionCounts();
            resetQuiz();
        }

        function switchStudyMode(mode) {
            studyMode = mode;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.getElementById('btn-all').className = mode === 'all' ? 'py-2 px-4 rounded-lg font-semibold transition-all bg-blue-500 text-white shadow-lg' : 'py-2 px-4 rounded-lg font-semibold transition-all bg-white text-blue-500 border-2 border-blue-500 hover:bg-blue-50';
            document.getElementById('btn-known').className = mode === 'known' ? 'py-2 px-4 rounded-lg font-semibold transition-all bg-green-500 text-white shadow-lg' : 'py-2 px-4 rounded-lg font-semibold transition-all bg-white text-green-500 border-2 border-green-500 hover:bg-green-50';
            document.getElementById('btn-unknown').className = mode === 'unknown' ? 'py-2 px-4 rounded-lg font-semibold transition-all bg-orange-500 text-white shadow-lg' : 'py-2 px-4 rounded-lg font-semibold transition-all bg-white text-orange-500 border-2 border-orange-500 hover:bg-orange-50';
            
            resetQuiz();
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('btn-pinyin').addEventListener('click', () => switchMode('pinyin'));
        document.getElementById('btn-greeting').addEventListener('click', () => switchMode('greeting'));
        document.getElementById('btn-character').addEventListener('click', () => switchMode('character'));
        
        document.getElementById('btn-all').addEventListener('click', () => switchStudyMode('all'));
        document.getElementById('btn-known').addEventListener('click', () => switchStudyMode('known'));
        document.getElementById('btn-unknown').addEventListener('click', () => switchStudyMode('unknown'));
        
        document.getElementById('btn-audio').addEventListener('click', function() {
            if (shuffledQuestions.length > 0) {
                const text = shuffledQuestions[currentQuestion].item.chinese;
                console.log('ğŸ¯ ë°œìŒ ë²„íŠ¼ í´ë¦­:', text);
                playAudio(text);
            }
        });
        
        document.getElementById('btn-show-pinyin').addEventListener('click', () => {
            showPinyin = !showPinyin;
            renderQuestion();
        });
        
        document.getElementById('btn-known-answer').addEventListener('click', markAsKnown);
        document.getElementById('btn-unknown-answer').addEventListener('click', markAsUnknown);
        document.getElementById('btn-next').addEventListener('click', nextQuestion);
        document.getElementById('btn-reset').addEventListener('click', resetQuiz);

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ê°ì§€ ë° ì•ˆë‚´
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            if (isMobile) {
                console.log('ğŸ“± ëª¨ë°”ì¼ ê¸°ê¸° ê°ì§€ë¨');
                
                // ëª¨ë°”ì¼ ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€ (ì„ íƒì )
                if (isIOS) {
                    console.log('ğŸ iOS ê¸°ê¸°: Safari ë¸Œë¼ìš°ì € ê¶Œì¥');
                } else {
                    console.log('ğŸ¤– Android ê¸°ê¸°: Chrome ë¸Œë¼ìš°ì € ê¶Œì¥');
                }
            }
            
            // ìŒì„± ëª©ë¡ ë¡œë“œ ëŒ€ê¸°
            await loadVoices();
            
            // ì‚¬ìš© ê°€ëŠ¥í•œ ì¤‘êµ­ì–´ ìŒì„± í™•ì¸ ë° ë¡œê·¸
            const voices = speechSynthesis.getVoices();
            const chineseVoices = voices.filter(voice => 
                voice.lang && (
                    voice.lang.includes('zh') || 
                    voice.lang.includes('Chinese') ||
                    voice.name.includes('Chinese') ||
                    voice.name.includes('Mandarin')
                )
            );
            
            console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ì¤‘êµ­ì–´ ìŒì„±:', chineseVoices.map(v => ({
                name: v.name,
                lang: v.lang,
                gender: v.name.includes('Female') ? 'Female' : v.name.includes('Male') ? 'Male' : 'Unknown'
            })));
            
            if (chineseVoices.length > 0) {
                console.log('âœ… ê³ í’ˆì§ˆ ì¤‘êµ­ì–´ ìŒì„±ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                console.log('âš ï¸ ì „ìš© ì¤‘êµ­ì–´ ìŒì„±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìŒì„±ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                
                if (isMobile) {
                    console.log('ğŸ’¡ ëª¨ë°”ì¼ì—ì„œ ì¤‘êµ­ì–´ ìŒì„±ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì–¸ì–´ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
                }
            }
            
            updateQuestionCounts();
            resetQuiz();
        });
    </script>
</body>
</html>